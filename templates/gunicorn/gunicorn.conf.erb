# gunicorn

description "gunicorn server"
author "Calen Pennington <cpennington@mitx.mit.edu>"

start on runlevel [2345]
stop on runlevel [!2345]

respawn
respawn limit 3 30

env PID=/var/run/gunicorn/<%= name %>.pid
env NEW_RELIC_CONFIG_FILE=/opt/wwc/newrelic.ini
env NEWRELIC=/usr/local/bin/newrelic-admin
<% if @workers -%>
env WORKERS=<%= @workers %>
<% else -%>
env WORKERS=<%= 4 * @processorcount.to_i %>
<% end -%>
env PORT=<%= @port %>
env LANG=en_US.UTF-8
env DJANGO_SETTINGS_MODULE=<%= @settings_module %>

pre-start script
<% pre_start_commands.each do |cmd| -%>
    <%= cmd %>
<% end -%>
end script

chdir <%= @package_root %>
setuid makeitso

<% case app_interface
    when 'django' %>

exec $NEWRELIC run-program /usr/local/bin/gunicorn_django -b 127.0.0.1:$PORT -w $WORKERS --timeout=<%= @timeout %> --pythonpath=<%= @package_root %> --settings=<%= @settings_module %>
<% when 'wsgi' %>

exec $NEWRELIC run-program /usr/local/bin/gunicorn --preload -b 127.0.0.1:$PORT -w $WORKERS --timeout=<%= @timeout %> --pythonpath=<%= @package_root %> <%= @wsgi_app %>

<% end %>
